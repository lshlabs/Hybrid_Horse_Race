# Hybrid Horse Race 개선안 정리

## 범위와 기준
이 문서는 현재 코드베이스(2026-02-05 기준)를 빠르게 읽고 확인한 개선 포인트를 정리한 것입니다. 구현/문서 불일치, 멀티플레이 동기화 리스크, 데이터 모델 일관성 등을 우선순위로 정리했습니다.

## 요약 (한눈에 보기)
- 최우선: `hostId` 누락으로 호스트 권한/플로우가 깨질 수 있음
- 중요: 클라이언트 중심 레이스/증강 랜덤으로 멀티플레이 동기화 리스크 큼
- 중요: 문서와 코드 상수/구현 범위가 어긋남
- 개선: 룸 설정 데이터와 실제 제약이 불일치

## 개선안 (우선순위 순)

### 1) 룸 문서에 `hostId` 누락 (치명적)
- 현상
  - `functions/src/index.ts`의 `createRoom`에서 룸 문서에 `hostId`를 저장하지 않음
  - `functions/src/utils.ts`의 `isHost`는 `room.hostId`를 참조
  - 프런트 `frontend/src/pages/LobbyPage.tsx`도 `room.hostId` 의존
- 영향
  - 호스트 판별 실패
  - `startGame`, `updateRoomSettings` 등 호스트 전용 기능이 정상 동작하지 않을 수 있음
- 개선안
  - `createRoom`에서 `hostId: playerId` 저장
  - `frontend/src/hooks/useRoom.ts`의 `Room` 타입에 `hostId` 추가
  - `functions/src/types.ts`의 `Room` 타입에도 `hostId` 추가

### 2) 멀티플레이 동기화 리스크 (클라이언트 랜덤)
- 현상
  - 레이스 결과/증강 선택이 클라이언트에서 `Math.random()` 기반으로 생성됨
  - 클라이언트마다 결과가 달라질 가능성 있음
- 개선안 (선택지)
  - A안: 서버(Functions)에서 레이스 시뮬레이션 및 증강 선택을 수행하고 결과만 전달
  - B안: 공통 시드 기반 PRNG로 모든 클라이언트가 동일 결과를 재현
  - 최소 조치: `roomId + setIndex` 기반 시드로 증강/레이스 결과 동기화

### 3) 문서와 구현 불일치
- 현상
  - `docs/backend-quick-start.md`는 구현 범위를 축소해서 안내
  - 실제로는 `startGame`, `leaveRoom`, `updateRoomSettings`, `selectHorse`, `submitFinalRaceResult`까지 구현됨
- 개선안
  - 문서에 실제 구현 범위를 반영
  - “미구현 목록”과 “구현 완료” 목록을 분리해서 온보딩 혼선 제거

### 4) 스탯 설계 문서 vs 코드 상수 불일치
- 현상
  - 문서(whitepaper)는 능력치 20 기준 설계를 강조
  - 코드(`frontend/src/engine/race/constants.ts`)는 `DEFAULT_MAX_STAT = 40`
  - `generateRandomStats()`는 최대 20 기준 분배
- 영향
  - 밸런스 분석 시 문서 기준과 실제 체감이 어긋날 수 있음
- 개선안
  - 문서 기준을 코드에 맞추거나, 코드 상수를 문서 기준으로 정렬
  - 정규화/상한 기준에 대한 단일 기준 정의

### 5) 게임 플로우 일부 미완성
- 현상
  - 프런트에서 `selectAugment`, `rerollAugments`, `startRace`, `skipSet` 호출 준비됨
  - 서버 구현은 없음
- 개선안
  - Phase별 우선순위대로 Functions 구현
  - 미구현 상태에서는 프런트 호출부 비활성/가드 처리

### 6) 룸 설정과 실제 제약 불일치
- 현상
  - `LandingPage`에서 `playerCount` 설정 가능
  - 서버는 `isRoomFull`에서 8명 고정
- 개선안
  - 룸 문서에 `maxPlayers` 저장
  - `joinRoom`에서 해당 값으로 검증

### 7) 공개 읽기 정책(보안/운영 리스크)
- 현상
  - Firestore 규칙: read 전면 허용, write 전면 차단
- 개선안
  - 공개 전략 유지 시에도 공유 링크 관리/주의 안내 필요
  - 장기적으로는 인증/토큰 기반 접근 제어 고려

### 8) RacePage 접근 UX
- 현상
  - `roomId` 없이 `/race` 진입 시 사용자 안내/리다이렉트 부족
- 개선안
  - `roomId` 없으면 랜딩으로 리다이렉트 또는 명확한 오류 UI 제공

## 빠른 실행 체크리스트
- `createRoom`에 `hostId` 저장 + 타입 동기화
- 문서 업데이트(backend-quick-start, whitepaper 기준 정리)
- 멀티플레이 동기화 전략 결정(A안/B안)
- 미구현 Functions 계획 확정 및 우선 구현

## 참고 파일
- `functions/src/index.ts`
- `functions/src/utils.ts`
- `functions/src/types.ts`
- `frontend/src/hooks/useRoom.ts`
- `frontend/src/pages/LobbyPage.tsx`
- `frontend/src/engine/race/constants.ts`
- `docs/backend-quick-start.md`
- `docs/game-design-whitepaper.md`
