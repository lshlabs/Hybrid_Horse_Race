# 테스트 페이지 데이터 흐름 개선 사항 적용 완료

본 문서는 `테스트 페이지 데이터 흐름 개선 사항 정리.md`에서 제안된 개선 사항들이 실제로 적용된 내용을 정리한 것입니다.

---

## 적용 완료된 개선 사항

### 1. playerId 생성 및 책임 범위 정리 ✅

#### LandingPageTest
- `hostId` → `playerId`로 변경
- playerId를 localStorage에 저장 (`dev_player_id`)
- playerId를 URL 파라미터로 전달

#### LobbyPageTest
- URL에 playerId가 없으면 `getUserId()`로 새로 생성
- URL에 playerId가 있으면 기존 값 사용
- playerId를 localStorage에 저장 (`dev_player_id`)

#### HorseSelectionPageTest, RacePageTest
- URL에서 playerId를 받되, 없으면 localStorage에서 fallback

```typescript
const playerId = searchParams.get('playerId') || localStorage.getItem('dev_player_id') || ''
```

---

### 2. hostId와 playerId 개념 분리 ✅

- 모든 페이지에서 `hostId` 대신 `playerId` 사용
- `isHost`는 Player 객체의 role 속성으로 관리
- 로그 출력 시 `{ playerId, isHost: true/false }` 형식 사용

---

### 3. 게임 설정 데이터 전달 방식 개선 ✅

#### LandingPageTest
```typescript
// 게임 설정을 localStorage에 저장
const roomConfig = {
  playerCount,
  roundCount,
  rerollLimit: rerollCount,
}
localStorage.setItem('dev_room_config', JSON.stringify(roomConfig))
```

#### 모든 후속 페이지 (Lobby, HorseSelection, Race, RaceResult)
```typescript
// localStorage에서 설정 불러오기
const roomConfig = (() => {
  try {
    const saved = localStorage.getItem('dev_room_config')
    if (saved) {
      return JSON.parse(saved)
    }
  } catch (err) {
    console.warn('Failed to load room config:', err)
  }
  // 기본값
  return {
    playerCount: 2,
    roundCount: 3,
    rerollLimit: 2,
  }
})()
```

#### URL 파라미터 간소화
- 기존: `roomId`, `playerId`, `playerCount`, `roundCount`, `rerollLimit` 전달
- 개선: `roomId`, `playerId`만 전달 (설정은 localStorage)

---

### 4. 말 선택 데이터 구조 확장 ✅

#### HorseSelectionPageTest
```typescript
// 개선 전
localStorage.setItem('dev_selected_horse', JSON.stringify(horseData))

// 개선 후
const saved = localStorage.getItem('dev_selected_horses')
const horsesData = saved ? JSON.parse(saved) : {}
horsesData[playerId] = horseData
localStorage.setItem('dev_selected_horses', JSON.stringify(horsesData))
```

#### RacePageTest
```typescript
// 개선 전
const saved = localStorage.getItem('dev_selected_horse')
const horseData = JSON.parse(saved)

// 개선 후
const saved = localStorage.getItem('dev_selected_horses')
const horsesData = JSON.parse(saved) as Record<string, SavedHorseData>
const horseData = horsesData[playerId]
```

**효과:**
- 멀티플레이 테스트 확장 가능
- 각 playerId별 선택한 말 독립 관리

---

### 5. RaceResultPage 데이터 신뢰 소스 단일화 ✅

#### RaceResultPageTest
```typescript
// location.state 기반 데이터만 신뢰
const state = location.state as LocationState | null
const finalRankingsFromState = state?.finalRankings

// Mock 데이터 사용 여부 명시
const isUsingMockData = !finalRankingsFromState || finalRankingsFromState.length === 0

// UI에 Mock 데이터 사용 경고 표시
{isUsingMockData && (
  <div className="rounded bg-yellow-600/20 px-3 py-1 border border-yellow-500/40">
    <span className="text-yellow-400">⚠️ Mock 데이터 사용 중</span>
  </div>
)}
```

**효과:**
- 데이터 출처 명확화
- 잘못된 접근 시 시각적 피드백 제공

---

### 6. CustomEvent와 페이지 이동 역할 분리 ✅

#### RacePageTest
```typescript
// CustomEvent 수신 후 location.state로 전달
useEffect(() => {
  const handleFinalResult = (event: Event) => {
    const customEvent = event as CustomEvent<{...}>
    
    // navigate state로 데이터 전달
    navigate('/race-result-test', {
      state: {
        finalRankings: customEvent.detail.finalRankings,
        roomId: customEvent.detail.roomId || roomId,
        playerId: customEvent.detail.playerId || playerId,
      }
    })
  }

  window.addEventListener('race-final-result', handleFinalResult)
  return () => window.removeEventListener('race-final-result', handleFinalResult)
}, [navigate, roomId, playerId])
```

**효과:**
- CustomEvent: Phaser ↔ React 통신
- navigate: 페이지 라우팅 및 데이터 전달
- 책임 분리 명확화

---

### 7. playerId localStorage 저장 (테스트 안정성) ✅

모든 주요 진입점에서 playerId를 localStorage에 저장:

```typescript
localStorage.setItem('dev_player_id', playerId)
```

**효과:**
- 페이지 새로고침 시에도 playerId 유지
- 중간 페이지 직접 접근 시 fallback 가능
- 테스트 중 세션 안정성 향상

---

## 변경된 localStorage 키 구조

### 기존 구조
```typescript
dev_selected_horse: SavedHorseData
dev_player_names: Record<string, string>
dev_participant_ids: string[]
```

### 개선된 구조
```typescript
dev_player_id: string                           // 추가
dev_room_config: {                              // 추가
  playerCount: number
  roundCount: number
  rerollLimit: number
}
dev_selected_horses: Record<playerId, SavedHorseData>  // 변경 (단수 → 복수)
dev_player_names: Record<string, string>        // 유지
dev_participant_ids: string[]                   // 유지
```

---

## 데이터 흐름 변경 사항

### 기존 흐름
```
LandingPageTest
  ↓ URL: roomId, playerCount, roundCount, rerollLimit
LobbyPageTest
  ↓ URL: roomId, playerId?, playerCount, roundCount, rerollLimit
HorseSelectionPageTest
  ↓ URL: roomId, playerId?, playerCount, roundCount, rerollLimit
  ↓ localStorage: dev_selected_horse
RacePageTest
  ↓ CustomEvent + location.state
RaceResultPageTest
```

### 개선된 흐름
```
LandingPageTest
  ↓ URL: roomId, playerId
  ↓ localStorage: dev_player_id, dev_room_config
LobbyPageTest (playerId 생성 가능)
  ↓ URL: roomId, playerId
  ↓ localStorage: dev_player_id (update)
HorseSelectionPageTest
  ↓ URL: roomId, playerId
  ↓ localStorage: dev_selected_horses[playerId]
RacePageTest
  ↓ CustomEvent → location.state (명확한 분리)
RaceResultPageTest (location.state 신뢰)
```

---

## 개선 효과

### 1. URL 파라미터 간소화
- 전달 파라미터 감소: 5개 → 2개
- navigate 호출 수정 범위 축소
- 설정 변경 시 유연성 증가

### 2. 데이터 구조 확장성
- playerId 기반 데이터 관리
- 멀티플레이 테스트 확장 준비
- 실서비스 전환 용이

### 3. 테스트 안정성
- 새로고침 시에도 데이터 유지
- fallback 메커니즘 강화
- 디버깅 편의성 향상

### 4. 책임 명확화
- playerId 생성: Lobby
- 설정 저장: Landing
- 데이터 신뢰: location.state (Result)
- 통신 분리: CustomEvent vs navigate

---

## 테스트 시나리오

### 정상 플로우
1. LandingPageTest에서 설정 후 룸 생성
   - playerId, roomConfig localStorage 저장
2. LobbyPageTest에서 플레이어 준비
3. HorseSelectionPageTest에서 말 선택
   - dev_selected_horses[playerId] 저장
4. RacePageTest에서 레이스 진행
5. RaceResultPageTest에서 결과 확인
   - location.state 기반 렌더링

### 예외 플로우
1. 중간 페이지 직접 접근
   - localStorage fallback 동작
2. 새로고침
   - playerId, roomConfig 유지
3. RaceResult 직접 접근
   - Mock 데이터 경고 표시

---

## 마이그레이션 가이드

기존 테스트 데이터를 사용 중인 경우:

```typescript
// 브라우저 콘솔에서 실행
// 1. 기존 단일 말 데이터를 playerId 기반으로 변환
const oldHorse = localStorage.getItem('dev_selected_horse')
if (oldHorse) {
  const playerId = localStorage.getItem('dev_player_id') || 'player-0'
  const newHorses = { [playerId]: JSON.parse(oldHorse) }
  localStorage.setItem('dev_selected_horses', JSON.stringify(newHorses))
  localStorage.removeItem('dev_selected_horse') // 선택적
}

// 2. 또는 전체 초기화
localStorage.clear()
```

---

## 다음 단계

### 실서비스 전환 시 추가 고려사항
1. Firebase Realtime Database 연동
   - localStorage → Firestore 마이그레이션
2. 멀티플레이 동기화
   - playerId 기반 데이터 구조 활용
3. 에러 핸들링 강화
   - playerId 없을 때 명시적 에러 처리
4. 권한 관리
   - isHost 기반 기능 제한

### 추가 개선 가능 항목
1. TypeScript 타입 강화
   - roomConfig, horsesData 타입 정의
2. localStorage 유틸 함수 분리
   - `getDevConfig()`, `setDevConfig()` 등
3. 테스트 데이터 초기화 UI
   - "테스트 데이터 초기화" 버튼 추가

---

## 결론

본 개선 사항 적용으로:
- **현재 테스트 구조를 유지하면서도**
- **실서비스로 자연스럽게 확장 가능한**
- **명확하고 안정적인 데이터 흐름을 확보**했습니다.

모든 변경사항은 역호환성을 고려하여 fallback 메커니즘을 포함하고 있으며, 기존 테스트 시나리오를 그대로 사용할 수 있습니다.
