# 테스트 페이지 데이터 흐름 개선 사항 정리

본 문서는 현재 테스트 페이지 기반 데이터 흐름 구조를 유지하면서, **혼란 가능성이 있는 지점과 확장 시 문제가 될 수 있는 부분을 명확히 정리하고 개선 방향을 문서화**한 것이다.

---

## 1. playerId 생성 및 책임 범위 정리

### 현재 구조

* LandingPageTest

  * 호스트의 경우 room 생성과 함께 `hostId` 생성
* LobbyPageTest

  * URL에 `playerId`가 없는 경우 신규 참여자로 간주
  * URL에 `playerId`가 있는 경우 기존 플레이어로 간주

이 구조는 **초대 링크를 통해 Lobby부터 진입하는 플레이어 시나리오를 고려했을 때 올바른 설계**이다.

### 개선 및 명문화 사항

* `playerId`는 **Landing이 아닌 Lobby에서 생성될 수 있음**
* LobbyPageTest에서의 책임을 명확히 한다:

```txt
LobbyPageTest 규칙
- URL에 playerId가 없을 경우:
  - 신규 플레이어로 간주
  - getUserId()를 통해 playerId 생성
  - 이후 모든 페이지 이동 시 playerId를 포함
```

### playerId 존재 범위 규칙

* Lobby 진입 이전: `playerId`는 optional
* Lobby 진입 이후: `playerId`는 반드시 존재해야 함

---

## 2. hostId와 playerId 개념 분리

### 문제점

* Landing에서 생성되는 `hostId`와 이후 사용되는 `playerId`가 개념적으로 혼재됨

### 권장 사고 모델

* `playerId`: 모든 사용자가 가지는 고유 식별자
* `host`: room 내 역할(role)의 개념

```ts
playerId: string
isHost: boolean
```

* LandingPageTest

  * playerId 생성
  * isHost = true
* 초대 링크 진입 플레이어

  * playerId 생성
  * isHost = false

※ 코드 변경이 필수는 아니며, **데이터 모델 사고 기준 정리 목적**

---

## 3. 게임 설정 데이터 전달 방식 개선

### 현재 구조

* 아래 값들이 모든 페이지 간 이동 시 URL 파라미터로 전달됨

  * playerCount
  * roundCount
  * rerollLimit

### 문제점

* URL이 전역 상태 저장소 역할을 수행
* 설정 추가/변경 시 navigate 수정 범위가 큼

### 개선 제안 (테스트 환경 기준)

#### 권장 방식

* LobbyPageTest에서 한 번만 localStorage에 저장

```ts
dev_room_config = {
  playerCount,
  roundCount,
  rerollLimit
}
```

* 이후 페이지에서는 URL이 아닌 localStorage 기준으로 참조

---

## 4. 말 선택 데이터 구조 확장 가능성

### 현재 구조

* 단일 플레이어 기준

```ts
dev_selected_horse: HorseData
```

### 문제점

* 멀티플레이 테스트 확장 시

  * 어떤 플레이어가 어떤 말을 선택했는지 표현 불가

### 개선 제안 (구조만 선행 정의)

```ts
dev_selected_horses: Record<playerId, HorseData>
```

* 현재 테스트에서는 자신의 playerId만 사용
* 구조 변경만으로 멀티플레이 대응 가능

---

## 5. RaceResultPage 데이터 신뢰 소스 단일화

### 현재 구조

* finalRankings 출처가 복수

  * location.state
  * 없을 경우 mock 생성
* roomId 또한 URL / state 혼용

### 문제점

* Result 페이지가 신뢰하는 데이터 기준이 불명확

### 개선 원칙

* RaceResultPage는 **location.state 기반 데이터만 신뢰**
* state가 없을 경우:

  * 명시적으로 mock 결과 페이지 렌더링
  * 또는 잘못된 접근 처리

```ts
if (!finalRankings) {
  return <MockResult />
}
```

---

## 6. CustomEvent와 페이지 이동 역할 분리

### 현재 구조

* RacePageTest에서

  * CustomEvent 발생
  * 해당 데이터를 다시 navigate state로 전달

### 개선 방향

* CustomEvent

  * Phaser ↔ React 내부 통신 용도로만 사용
* 페이지 이동

  * navigate(state) 단일 책임

→ 이벤트 시스템과 라우팅 책임 분리

---

## 7. 선택적 개선 사항 (테스트 안정성)

### playerId localStorage 저장

```ts
dev_player_id = playerId
```

* 새로고침
* Race / Result 직접 접근
* 테스트 중 세션 안정성 향상

---

## 최종 정리

### 현재 구조 유지 가능

* 전체 페이지 흐름
* CustomEvent 기반 Phaser 통신
* dev_ 네임스페이스 localStorage 사용

### 문서화 및 개선 핵심 포인트

1. playerId 생성 책임은 Lobby에 있음
2. host는 역할 개념, playerId는 식별자
3. 설정 데이터는 단일 저장소(localStorage) 권장
4. 말 선택 데이터는 playerId 기준 확장 구조
5. Result 페이지 데이터 신뢰 소스 단일화

본 개선 사항을 반영하면, **테스트 구조를 유지하면서도 실서비스로 자연스럽게 확장 가능한 데이터 흐름을 확보할 수 있다.**
